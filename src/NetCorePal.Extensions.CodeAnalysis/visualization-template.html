<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{TITLE}}</title>
    <script src="https://unpkg.com/mermaid@11.9.0/dist/mermaid.min.js"></script>
    <script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --sidebar-width: 280px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            display: block;
            min-height: 100vh;
            position: relative;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            border-right: none;
            min-width: 200px;
            max-width: 500px;
            transition: transform 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1001;
        }

        .sidebar-resizer {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            width: 4px;
            height: 100vh;
            background: transparent;
            cursor: col-resize;
            z-index: 1000;
        }
        
        .sidebar-resizer:hover,
        .sidebar-resizer.dragging {
            background: #007ACC;
        }

        .main-content {
            display: block;
            min-width: 0;
            transition: margin-left 0.3s ease;
            margin-left: var(--sidebar-width);
            overflow-y: auto;
            min-height: 100vh;
            padding: 20px;
            background-color: white;
        }

        .sidebar h1 {
            font-size: 20px;
            margin-bottom: 30px;
            margin-top: 20px;
            padding-bottom: 15px;
            padding-right: 50px;
            border-bottom: 2px solid #34495e;
            color: #ecf0f1;
            width: 100%;
            box-sizing: border-box;
            line-height: 28px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-group {
            margin-bottom: 25px;
            width: 100%;
            box-sizing: border-box;
        }

        .nav-group h3 {
            font-size: 14px;
            color: #bdc3c7;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            box-sizing: border-box;
        }

        .nav-item {
            display: block;
            padding: 12px 15px;
            margin-bottom: 5px;
            color: #ecf0f1;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            box-sizing: border-box;
        }

        .nav-item:hover {
            background-color: #34495e;
            transform: translateX(5px);
        }

        .nav-item.active {
            background-color: #3498db;
            color: white;
            font-weight: 600;
        }

        .nav-item.chain-item {
            padding-left: 25px;
            font-size: 13px;
            color: #bdc3c7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            box-sizing: border-box;
        }

        .nav-item.chain-item:hover {
            background-color: #34495e;
            color: #ecf0f1;
        }

        .nav-item.chain-item.active {
            background-color: #e74c3c;
            color: white;
        }

        /* å¿«ç…§é€‰æ‹©å™¨æ ·å¼ */
        .snapshot-selector {
            width: 100%;
            padding: 12px 15px;
            background-color: #34495e;
            color: #ecf0f1;
            border: 1px solid #4a5f7f;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            margin-top: 10px;
        }

        .snapshot-selector:hover {
            background-color: #3d566e;
            border-color: #5a7fa0;
        }

        .snapshot-selector:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .snapshot-selector option {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
        }

        .content-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }

        .content-header h2 {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 3px;
        }

        .content-header p {
            color: #7f8c8d;
            font-size: 13px;
        }

        .diagram-container {
            background-color: #fefefe;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 200px;
            height: auto;
            text-align: center;
            overflow: visible;
            display: block;
        }

        .mermaid {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            width: auto;
            height: auto !important;
            overflow: visible;
            min-height: 200px;
            box-sizing: border-box;
        }

        #diagramContent {
            width: 100%;
            height: auto;
            overflow: visible;
            display: block;
            box-sizing: border-box;
        }

        .mermaid svg {
            max-width: 100% !important;
            height: auto !important;
            width: auto !important;
            display: block;
            margin: 0 auto;
            box-sizing: border-box !important;
            max-height: 80vh;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
        }

        .loading::before {
            content: 'â³';
            font-size: 24px;
            display: block;
            margin-bottom: 10px;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #f44336;
        }

        .chain-counter {
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            margin-left: 10px;
            font-weight: bold;
        }

        .expand-toggle {
            float: right;
            font-size: 12px;
            cursor: pointer;
            color: #bdc3c7;
        }

        .expand-toggle:hover {
            color: #ecf0f1;
        }

        .mermaid-live-button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(238, 90, 36, 0.3);
        }

        .mermaid-live-button:hover {
            background: linear-gradient(135deg, #ee5a24, #e55039);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(238, 90, 36, 0.4);
        }

        .mermaid-live-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(238, 90, 36, 0.3);
        }

        .diagram-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .diagram-title-section {
            flex: 1;
        }

        .chains-collapsed .chain-item {
            display: none;
        }

        .chains-container {
            width: 100%;
            box-sizing: border-box;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-container {
            margin-bottom: 20px;
            padding: 0 5px;
        }

        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #34495e;
            border-radius: 6px;
            background-color: #34495e;
            color: #ecf0f1;
            font-size: 14px;
            transition: all 0.3s ease;
            outline: none;
        }

        .search-box::placeholder {
            color: #bdc3c7;
        }

        .search-box:focus {
            border-color: #3498db;
            background-color: #2c3e50;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .search-results {
            margin-top: 10px;

        .search-result-item {
            padding: 8px 12px;
            margin-bottom: 3px;
            background-color: #2c3e50;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            color: #ecf0f1;
            border-left: 3px solid transparent;
            height: 40px;
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .search-result-item:hover {
            background-color: #34495e;
            border-left-color: #3498db;
            transform: translateX(3px);
        }

        .search-result-item.highlight {
            background-color: #3498db;
            border-left-color: #2980b9;
        }

        .search-no-results {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
        }

        .search-category {
            font-size: 11px;
            color: #95a5a6;
            margin-left: 8px;
            flex-shrink: 0; /* åˆ†ç±»æ ‡ç­¾ä¸æ”¶ç¼© */
            white-space: nowrap;
        }

        .search-category-header {
            font-size: 12px;
            font-weight: bold;
            color: #3498db;
            margin: 8px 0 4px 0;
            padding: 4px 8px;
            border-bottom: 1px solid #34495e;
        }

        .search-item-main {
            display: flex;
            align-items: center;
            width: 100%;
            min-width: 0; /* å…è®¸ flex å­å…ƒç´ æ”¶ç¼© */
        }

        .search-item-icon {
            margin-right: 8px;
            font-size: 14px;
            flex-shrink: 0; /* å›¾æ ‡ä¸æ”¶ç¼© */
        }

        .search-item-name {
            flex: 1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0; /* å…è®¸æ–‡æœ¬æ”¶ç¼© */
        }

        .search-item-name mark {
            background-color: #f39c12;
            color: #2c3e50;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .search-item-fullname {
            font-size: 11px;
            color: #95a5a6;
            margin-top: 2px;
            padding-left: 22px;
        }

        .search-item-fullname mark {
            background-color: #f39c12;
            color: #2c3e50;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .search-item-charts {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 2px;
            padding-left: 22px;
            font-style: italic;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            .main-content {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-resizer" id="sidebarResizer"></div>
            
            <h1>{{TITLE}}</h1>
            
            <!-- å¿«ç…§é€‰æ‹©å™¨ -->
            <div class="nav-group" id="snapshotSelectorGroup" style="display: none;">
                <h3>å¿«ç…§ç‰ˆæœ¬</h3>
                <select id="snapshotSelector" class="snapshot-selector" onchange="switchSnapshot(this.value)">
                    <!-- åŠ¨æ€ç”Ÿæˆå¿«ç…§é€‰é¡¹ -->
                </select>
            </div>
            
            <!-- æœç´¢æ¡† -->
            <div class="search-container">
                <input type="text" id="searchBox" class="search-box" placeholder="æœç´¢å›¾è¡¨æˆ–å…ƒç´ ..." oninput="performSearch()">
                <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>
            
            <div class="nav-group">
                <h3>å›¾è¡¨å±•ç¤º</h3>
                <a class="nav-item" data-diagram="Statistics" href="#Statistics" title="ğŸ“Š ç»Ÿè®¡ä¿¡æ¯">
                    ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
                </a>
                <a class="nav-item" data-diagram="HistoricalTrends" href="#HistoricalTrends" title="ğŸ“ˆ å†å²è¶‹åŠ¿" style="display: none;" id="historicalTrendsMenuItem">
                    ğŸ“ˆ å†å²è¶‹åŠ¿
                </a>
                <a class="nav-item" data-diagram="ArchitectureOverview" href="#ArchitectureOverview" title="ğŸ›ï¸ æ€»è§ˆå›¾">
                    ğŸ›ï¸ æ€»è§ˆå›¾
                </a>
            </div>

            <div class="nav-group">
                <h3>èšåˆå…³ç³»å›¾ <span class="expand-toggle" onclick="toggleAggregateDiagrams()">â–¶</span> <span class="chain-counter" id="aggregateDiagramCounter"></span></h3>
                <div class="chains-container" id="aggregateDiagramsContainer">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„èšåˆå…³ç³»å›¾èœå• -->
                </div>
            </div>

            <div class="nav-group">
                <h3>å¤„ç†æµç¨‹å›¾ <span class="expand-toggle" onclick="toggleProcessingFlow()">â–¶</span> <span class="chain-counter" id="processingFlowCounter">0</span></h3>
                <div class="chains-container" id="processingFlowContainer">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„å¤„ç†æµç¨‹å›¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="content-header">
                <div class="diagram-header">
                    <div class="diagram-title-section">
                        <h2 id="diagramTitle">é€‰æ‹©å›¾è¡¨ç±»å‹</h2>
                        <p id="diagramDescription">è¯·ä»å·¦ä¾§èœå•é€‰æ‹©è¦æŸ¥çœ‹çš„å›¾è¡¨ç±»å‹</p>
                    </div>
                    <div class="diagram-actions">
                        <button id="mermaidLiveButton" class="mermaid-live-button" style="display: none;" onclick="openInMermaidLive()">
                            ğŸ”— View in Mermaid Live
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="diagram-container">
                <div id="diagramContent">
                    <div class="loading">æ­£åœ¨åŠ è½½å›¾è¡¨æ•°æ®...</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // æœç´¢åŠŸèƒ½å®ç°
        function performSearch() {
            const query = document.getElementById('searchBox').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            if (!query) {
                resultsDiv.style.display = 'none';
                resultsDiv.innerHTML = '';
                return;
            }
            
            // å¢å¼ºæœç´¢é€»è¾‘ï¼šæ”¯æŒæœç´¢å›¾è¡¨åç§°å’ŒåŒ…å«çš„å…ƒç´ åç§°
            const results = allSearchableItems.filter(item => {
                // æœç´¢å›¾è¡¨åç§°
                const nameMatch = item.name && item.name.toLowerCase().includes(query);
                
                // æœç´¢åŒ…å«çš„å…ƒç´ åç§°
                const termsMatch = item.searchableTerms && item.searchableTerms.some(term => 
                    term && term.toLowerCase().includes(query)
                );
                
                return nameMatch || termsMatch;
            });
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="search-no-results">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            // ç›´æ¥æ˜¾ç¤ºæœç´¢ç»“æœï¼Œä¸è¿›è¡Œåˆ†ç»„
            let html = '';
            results.forEach(item => {
                const displayName = highlightSearchTerm(item.name, query);
                
                html += `
                    <div class="search-result-item" onclick="selectSearchResult(allSearchableItems[${allSearchableItems.indexOf(item)}])" title="${escapeHtml(item.name)}">
                        <div class="search-item-main">
                            <span class="search-item-icon">${item.icon}</span>
                            <span class="search-item-name">${displayName}</span>
                            <span class="search-category">${item.category}</span>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        // é«˜äº®æœç´¢è¯
        function highlightSearchTerm(text, query) {
            if (!text || !query) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        
        // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({
            startOnLoad: false,
            maxEdges: {{MAX_EDGES}},
            maxTextSize: {{MAX_TEXT_SIZE}},
            theme: 'base',
            themeVariables: {
                primaryColor: '#3498db',
                primaryTextColor: '#2c3e50',
                primaryBorderColor: '#2980b9',
                lineColor: '#34495e',
                secondaryColor: '#ecf0f1',
                tertiaryColor: '#bdc3c7',
                background: '#ffffff',
                mainBkg: '#ffffff',
                secondBkg: '#f8f9fa',
                tertiaryBkg: '#ecf0f1'
            },
            flowchart: {
                htmlLabels: true,
                curve: 'basis',
                diagramPadding: 20,
                useMaxWidth: false,
                useMaxHeight: false,
                nodeSpacing: 30,
                rankSpacing: 30
            },
            classDiagram: {
                htmlLabels: true,
                diagramPadding: 20,
                useMaxWidth: false,
                useMaxHeight: false
            }
        });

        // æ•°æ®æºæ•°ç»„ - æ¯ä¸ªå…ƒç´ åŒ…å«ä¸€ä¸ªå¿«ç…§çš„å®Œæ•´æ•°æ®
        const dataSources = {{DATA_SOURCES}};
        
        // å›¾è¡¨é…ç½®
        const diagramConfigs = {{DIAGRAM_CONFIGS}};
        
        // å½“å‰é€‰ä¸­çš„æ•°æ®æºç´¢å¼•
        let currentDataSourceIndex = 0;
        
        // å½“å‰æ•°æ®æº
        let currentDataSource = dataSources[currentDataSourceIndex];
        let statistics = currentDataSource.statistics;
        let analysisResult = currentDataSource.analysisResult;
        let diagrams = currentDataSource.diagrams;
        let allChainFlowCharts = currentDataSource.allChainFlowCharts;
        let allAggregateRelationDiagrams = currentDataSource.allAggregateRelationDiagrams;

        let currentDiagram = null;
        let currentDiagramData = null;
        let processingFlowExpanded = false;
        let aggregateDiagramsExpanded = false;
        
        // åˆ‡æ¢å¿«ç…§/æ•°æ®æº
        function switchSnapshot(index) {
            const selectedIndex = parseInt(index);
            if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= dataSources.length) {
                return;
            }
            
            currentDataSourceIndex = selectedIndex;
            currentDataSource = dataSources[currentDataSourceIndex];
            
            // æ›´æ–°å…¨å±€å˜é‡
            statistics = currentDataSource.statistics;
            analysisResult = currentDataSource.analysisResult;
            diagrams = currentDataSource.diagrams;
            allChainFlowCharts = currentDataSource.allChainFlowCharts;
            allAggregateRelationDiagrams = currentDataSource.allAggregateRelationDiagrams;
            
            // é‡æ–°ç”Ÿæˆå¯¼èˆª
            generateAggregateDiagramNavigation();
            generateChainNavigation();
            addNavigationListeners();
            
            // åˆ‡æ¢å¿«ç…§åï¼Œå§‹ç»ˆæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯é¡µé¢
            showDiagram('Statistics', false);
        }

        // åˆå§‹åŒ–å¿«ç…§é€‰æ‹©å™¨
        function initializeSnapshotSelector() {
            // æ˜¾ç¤º/éšè—å†å²è¶‹åŠ¿èœå•é¡¹ - éœ€è¦è‡³å°‘2ä¸ªå¿«ç…§
            const historicalTrendsMenuItem = document.getElementById('historicalTrendsMenuItem');
            if (historicalTrendsMenuItem) {
                if (dataSources.length >= 2) {
                    historicalTrendsMenuItem.style.display = 'block';
                } else {
                    historicalTrendsMenuItem.style.display = 'none';
                }
            }
            
            if (dataSources.length > 1) {
                const selectorGroup = document.getElementById('snapshotSelectorGroup');
                const selector = document.getElementById('snapshotSelector');
                
                if (selectorGroup && selector) {
                    selectorGroup.style.display = 'block';
                    
                    // ç”Ÿæˆé€‰é¡¹
                    selector.innerHTML = '';
                    dataSources.forEach((ds, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        const metadata = ds.metadata;
                        const label = metadata.description ? 
                            `${metadata.description} (${metadata.timestamp})` :
                            `ç‰ˆæœ¬ ${metadata.version} (${metadata.timestamp})`;
                        option.textContent = label;
                        if (index === 0) {
                            option.selected = true;
                        }
                        selector.appendChild(option);
                    });
                }
            }
        }
        
        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            initializeSnapshotSelector();
            generateAggregateDiagramNavigation();
            generateChainNavigation();
            addNavigationListeners();
            addHashChangeListener();
            handleInitialHash();
        }

        // ç”Ÿæˆèšåˆå…³ç³»å›¾å¯¼èˆª
        function generateAggregateDiagramNavigation() {
            const container = document.getElementById('aggregateDiagramsContainer');
            const counter = document.getElementById('aggregateDiagramCounter');
            if (container && counter) {
                container.innerHTML = '';
                counter.textContent = allAggregateRelationDiagrams.length;
                container.classList.add('chains-collapsed');
                allAggregateRelationDiagrams.forEach((agg, index) => {
                    const aggItem = document.createElement('a');
                    aggItem.className = 'nav-item chain-item';
                    aggItem.setAttribute('data-aggregate-diagram', index);
                    const aggId = encodeURIComponent(agg.name.replace(/[^a-zA-Z0-9ä¸€-é¾¥]/g, '-'));
                    aggItem.href = `#aggregate-diagram-${aggId}`;
                    aggItem.textContent = `ğŸ—‚ï¸ ${agg.name}`;
                    aggItem.title = `ğŸ—‚ï¸ ${agg.name}`;
                    container.appendChild(aggItem);
                });
            }
        }

        // ç”Ÿæˆå‘½ä»¤é“¾è·¯å¯¼èˆª
        function generateChainNavigation() {
            // å¤„ç†æµç¨‹å›¾å¯¼èˆª
            const processingContainer = document.getElementById('processingFlowContainer');
            const processingCounter = document.getElementById('processingFlowCounter');
            if (processingContainer && processingCounter) {
                processingContainer.innerHTML = '';
                processingCounter.textContent = allChainFlowCharts.length;
                
                // é»˜è®¤è®¾ç½®ä¸ºæŠ˜å çŠ¶æ€
                processingContainer.classList.add('chains-collapsed');
                allChainFlowCharts.forEach((chain, index) => {
                    const chainItem = document.createElement('a');
                    chainItem.className = 'nav-item chain-item';
                    chainItem.setAttribute('data-processing-flow', index);
                    const chainId = encodeURIComponent(chain.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '-'));
                    chainItem.href = `#processing-flow-${chainId}`;
                    chainItem.textContent = `ğŸ”„ ${chain.name}`;
                    chainItem.title = `ğŸ”„ ${chain.name}`;
                    processingContainer.appendChild(chainItem);
                });
            }
        }

        // æ·»åŠ å¯¼èˆªäº‹ä»¶ç›‘å¬
        function addNavigationListeners() {
            document.querySelectorAll('.nav-item[data-diagram]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const diagramType = item.getAttribute('data-diagram');
                    showDiagram(diagramType);
                });
            });
            document.querySelectorAll('.nav-item[data-aggregate-diagram]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const aggIndex = parseInt(item.getAttribute('data-aggregate-diagram'));
                    if (!aggregateDiagramsExpanded) {
                        toggleAggregateDiagrams();
                    }
                    showAggregateDiagram(aggIndex);
                });
            });
            // å¤„ç†æµç¨‹å›¾ç›‘å¬
            document.querySelectorAll('.nav-item.chain-item[data-processing-flow]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const chainIndex = parseInt(item.getAttribute('data-processing-flow'));
                    if (!isNaN(chainIndex)) {
                        showRequestChain(chainIndex);
                    }
                });
            });
        }

        // æ˜¾ç¤ºå›¾è¡¨
        async function showDiagram(diagramType, updateHash = true) {
            const config = diagramConfigs[diagramType];
            if (!config) return;

            if (updateHash) {
                window.location.hash = diagramType;
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-diagram="${diagramType}"]`).classList.add('active');

            document.getElementById('diagramTitle').textContent = config.title;
            document.getElementById('diagramDescription').textContent = config.description;
            hideMermaidLiveButton();

            const contentDiv = document.getElementById('diagramContent');
            
            // ç‰¹æ®Šå¤„ç†ç»Ÿè®¡ä¿¡æ¯é¡µé¢
            if (diagramType === 'Statistics') {
                showStatistics(contentDiv);
                return;
            }
            
            // ç‰¹æ®Šå¤„ç†å†å²è¶‹åŠ¿é¡µé¢
            if (diagramType === 'HistoricalTrends') {
                showHistoricalTrends(contentDiv);
                return;
            }
            
            contentDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆå›¾è¡¨...</div>';

            try {
                await new Promise(resolve => setTimeout(resolve, 300));
                const diagramData = diagrams[diagramType];
                if (!diagramData) {
                    throw new Error('å›¾è¡¨æ•°æ®ä¸å­˜åœ¨');
                }
                await renderMermaidDiagram(diagramData, contentDiv);
                currentDiagram = diagramType;
                currentDiagramData = diagramData;
                showMermaidLiveButton();
            } catch (error) {
                console.error('ç”Ÿæˆå›¾è¡¨å¤±è´¥:', error);
                const diagramData = diagrams[diagramType];
                contentDiv.innerHTML = `<div class="error">${formatErrorMessage('ç”Ÿæˆå›¾è¡¨å¤±è´¥', error)}</div>`;
                currentDiagram = diagramType;
                currentDiagramData = diagramData || '';
                showMermaidLiveButton();
            }
        }


        // æ¸²æŸ“Mermaidå›¾è¡¨
        async function renderMermaidDiagram(diagramData, container) {
            const diagramId = `diagram-${Date.now()}`;
            
            try {
                container.innerHTML = '';
                const diagramElement = document.createElement('div');
                diagramElement.id = diagramId;
                diagramElement.className = 'mermaid';
                diagramElement.textContent = diagramData;
                container.appendChild(diagramElement);
                await mermaid.run({ nodes: [diagramElement] });
            } catch (error) {
                console.error('Mermaidæ¸²æŸ“å¤±è´¥:', error);
                // ç¡®ä¿åœ¨é”™è¯¯æ—¶ä¹Ÿè®¾ç½®å½“å‰å›¾è¡¨æ•°æ®ï¼Œè¿™æ ·æŒ‰é’®å¯ä»¥æ­£å¸¸æ˜¾ç¤º
                currentDiagramData = diagramData;
                throw error;
            }
        }

        // æ˜¾ç¤ºå¤„ç†æµç¨‹å›¾
        async function showRequestChain(chainIndex, updateHash = true) {
            const chain = allChainFlowCharts[chainIndex];
            if (!chain) return;

            // å¦‚æœå¤„ç†æµç¨‹å›¾èœå•æ˜¯æŠ˜å çš„ï¼Œåˆ™å±•å¼€å®ƒ
            if (!processingFlowExpanded) {
                toggleProcessingFlow();
            }

            if (updateHash) {
                const chainId = encodeURIComponent(chain.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '-'));
                window.location.hash = `processing-flow-${chainId}`;
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-processing-flow="${chainIndex}"]`).classList.add('active');

            document.getElementById('diagramTitle').textContent = `${chain.name}`;
            document.getElementById('diagramDescription').textContent = 'å¤„ç†æµç¨‹å›¾ï¼šå±•ç¤ºå•ä¸ªè¯·æ±‚çš„å®Œæ•´æµè½¬è¿‡ç¨‹';
            hideMermaidLiveButton();

            const contentDiv = document.getElementById('diagramContent');
            contentDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆå¤„ç†æµç¨‹å›¾...</div>';

            try {
                setTimeout(function() {
                    renderMermaidDiagram(chain.diagram, contentDiv).then(() => {
                        currentDiagram = `processing-flow-${chainIndex}`;
                        currentDiagramData = chain.diagram;
                        showMermaidLiveButton();
                    }).catch(error => {
                        console.error('ç”Ÿæˆå¤„ç†æµç¨‹å›¾å¤±è´¥:', error);
                        contentDiv.innerHTML = `<div class="error">${formatErrorMessage('ç”Ÿæˆå¤„ç†æµç¨‹å›¾å¤±è´¥', error)}</div>`;
                        currentDiagram = `processing-flow-${chainIndex}`;
                        currentDiagramData = chain.diagram;
                        showMermaidLiveButton();
                    });
                }, 200);
            } catch (error) {
                console.error('ç”Ÿæˆå¤„ç†æµç¨‹å›¾å¤±è´¥:', error);
                contentDiv.innerHTML = `<div class="error">${formatErrorMessage('ç”Ÿæˆå¤„ç†æµç¨‹å›¾å¤±è´¥', error)}</div>`;
                currentDiagram = `processing-flow-${chainIndex}`;
                currentDiagramData = chain.diagram;
                showMermaidLiveButton();
            }
        }


        // æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯
        function formatErrorMessage(prefix, error) {
            let message = error.message;
            if (message && message.toLowerCase().includes('too many edges')) {
                return `${prefix}: ${message}ã€‚å›¾è¡¨è¿‡äºå¤æ‚ï¼Œè¯·ç‚¹å‡» "ğŸ”— View in Mermaid Live" æŒ‰é’®åœ¨ Mermaid Live ä¸­æŸ¥çœ‹å®Œæ•´å›¾è¡¨ã€‚`;
            }
            return `${prefix}: ${message}`;
        }

        // æ˜¾ç¤º Mermaid Live æŒ‰é’®
        function showMermaidLiveButton() {
            const button = document.getElementById('mermaidLiveButton');
            if (button) {
                button.style.display = 'inline-flex';
            }
        }

        // éšè— Mermaid Live æŒ‰é’®
        function hideMermaidLiveButton() {
            const button = document.getElementById('mermaidLiveButton');
            if (button) {
                button.style.display = 'none';
            }
        }

        // åœ¨ Mermaid Live ä¸­æ‰“å¼€å½“å‰å›¾è¡¨
        function openInMermaidLive() {
            if (!currentDiagramData) {
                alert('æ²¡æœ‰å¯ç”¨çš„å›¾è¡¨æ•°æ®');
                return;
            }

            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰ pako åº“å¯ç”¨
                if (typeof pako !== 'undefined') {
                    // ä½¿ç”¨ pako å‹ç¼©æ–¹å¼ (é¦–é€‰)
                    const state = {
                        code: currentDiagramData,
                        mermaid: {
                            theme: 'default',
                            maxEdges: {{MAX_EDGES}},
                            maxTextSize: {{MAX_TEXT_SIZE}}
                        },
                        autoSync: true,
                        updateDiagram: true
                    };

                    const stateString = JSON.stringify(state);
                    const compressed = pako.deflate(stateString, { to: 'string' });
                    const encoded = btoa(String.fromCharCode.apply(null, compressed));
                    const mermaidLiveUrl = `https://mermaid.live/edit#pako:${encoded}`;

                    window.open(mermaidLiveUrl, '_blank');
                } else {
                    // å›é€€åˆ° base64 ç¼–ç æ–¹å¼
                    const encodedDiagram = btoa(unescape(encodeURIComponent(currentDiagramData)));
                    const mermaidLiveUrl = `https://mermaid.live/edit#base64:${encodedDiagram}`;
                    window.open(mermaidLiveUrl, '_blank');
                }
            } catch (error) {
                console.error('æ— æ³•æ‰“å¼€ Mermaid Live:', error);
                // å¦‚æœç¼–ç å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¼ é€’ä»£ç 
                try {
                    const simpleEncodedDiagram = btoa(currentDiagramData);
                    const fallbackUrl = `https://mermaid.live/edit#base64:${simpleEncodedDiagram}`;
                    window.open(fallbackUrl, '_blank');
                } catch (fallbackError) {
                    console.error('å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥:', fallbackError);
                    alert('æ— æ³•æ‰“å¼€ Mermaid Liveï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°');
                }
            }
        }

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯é¡µé¢
        function showStatistics(container) {
            const nodeTypeCounts = statistics.nodeStats;
            const relationshipTypeCounts = statistics.relationshipStats;
            
            // å®šä¹‰è¦æ˜¾ç¤ºçš„èŠ‚ç‚¹ç±»å‹ï¼ˆæŒ‰å®šä¹‰é¡ºåºï¼Œæ’é™¤æŒ‡å®šç±»å‹ï¼‰
            const displayNodeTypes = [
                'Controller',
                'Endpoint', 
                'CommandSender',
                'Command',
                'CommandHandler',
                'Aggregate',
                'DomainEvent',
                'IntegrationEvent',
                'DomainEventHandler',
                'IntegrationEventHandler',
                'IntegrationEventConverter'
            ];
            
            // å®šä¹‰è¦æ˜¾ç¤ºçš„å…³ç³»ç±»å‹ï¼ˆæŒ‰å®šä¹‰é¡ºåºï¼Œæ’é™¤æŒ‡å®šç±»å‹ï¼‰
            const displayRelationshipTypes = [
                'ControllerToCommand',
                'EndpointToCommand',
                'CommandSenderToCommand',
                'CommandToAggregate',
                'AggregateToDomainEvent',
                'DomainEventToHandler',
                'DomainEventHandlerToCommand',
                'IntegrationEventToHandler',
                'IntegrationEventHandlerToCommand',
                'DomainEventToIntegrationEvent'
            ];
            
            // è®¡ç®—è¿‡æ»¤åçš„æ€»æ•°
            const filteredNodeCount = displayNodeTypes.reduce((sum, type) => sum + (nodeTypeCounts[type] || 0), 0);
            const filteredRelationshipCount = displayRelationshipTypes.reduce((sum, type) => sum + (relationshipTypeCounts[type] || 0), 0);
            
            let html = '<div style="padding: 15px; font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; height: calc(100vh - 140px); overflow-y: auto;">';
            
            // æ€»ä½“ç»Ÿè®¡ - æ›´ç´§å‡‘çš„è®¾è®¡
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">';
            html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
            html += '<span style="font-size: 16px; font-weight: 600;">æ€»å…ƒç´ æ•°</span>';
            html += `<span style="font-size: 28px; font-weight: bold;">${filteredNodeCount}</span>`;
            html += '</div>';
            html += '<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
            html += '<span style="font-size: 16px; font-weight: 600;">æ€»å…³ç³»æ•°</span>';
            html += `<span style="font-size: 28px; font-weight: bold;">${filteredRelationshipCount}</span>`;
            html += '</div>';
            html += '</div>';
            
            // ä¸¤åˆ—å¸ƒå±€ - å·¦ä¾§å…ƒç´ ç»Ÿè®¡ï¼Œå³ä¾§å…³ç³»ç»Ÿè®¡
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100vh - 260px);">';
            
            // å…ƒç´ ç»Ÿè®¡
            html += '<div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow-y: auto;">';
            html += '<h2 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 8px; font-size: 18px;">ğŸ“Š å…ƒç´ ç»Ÿè®¡</h2>';
            html += '<div style="display: grid; gap: 8px;">';
            
            // æŒ‰å®šä¹‰é¡ºåºæ˜¾ç¤ºèŠ‚ç‚¹ç±»å‹
            displayNodeTypes.forEach(type => {
                const count = nodeTypeCounts[type] || 0;
                if (count > 0) {
                    const percentage = ((count / filteredNodeCount) * 100).toFixed(1);
                    html += '<div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #3498db; display: flex; justify-content: space-between; align-items: center; min-height: 32px;">';
                    html += `<div style="font-weight: 600; color: #2c3e50; font-size: 14px;">${type}</div>`;
                    html += '<div style="display: flex; align-items: center; gap: 12px;">';
                    html += `<div style="font-size: 16px; font-weight: bold; color: #e74c3c;">${count}</div>`;
                    html += `<div style="font-size: 11px; color: #7f8c8d; min-width: 35px;">${percentage}%</div>`;
                    html += '</div>';
                    html += '</div>';
                }
            });
            html += '</div></div>';
            
            // å…³ç³»ç»Ÿè®¡
            html += '<div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow-y: auto;">';
            html += '<h2 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #e74c3c; padding-bottom: 8px; font-size: 18px;">ğŸ”— å…³ç³»ç»Ÿè®¡</h2>';
            html += '<div style="display: grid; gap: 8px;">';
            
            // æŒ‰å®šä¹‰é¡ºåºæ˜¾ç¤ºå…³ç³»ç±»å‹
            displayRelationshipTypes.forEach(type => {
                const count = relationshipTypeCounts[type] || 0;
                if (count > 0) {
                    const percentage = ((count / filteredRelationshipCount) * 100).toFixed(1);
                    html += '<div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #e74c3c; display: flex; justify-content: space-between; align-items: center; min-height: 32px;">';
                    html += `<div style="font-weight: 600; color: #2c3e50; font-size: 14px;">${type}</div>`;
                    html += '<div style="display: flex; align-items: center; gap: 12px;">';
                    html += `<div style="font-size: 16px; font-weight: bold; color: #3498db;">${count}</div>`;
                    html += `<div style="font-size: 11px; color: #7f8c8d; min-width: 35px;">${percentage}%</div>`;
                    html += '</div>';
                    html += '</div>';
                }
            });
            html += '</div></div>';
            
            html += '</div></div>';
            
            container.innerHTML = html;
        }

        // æ˜¾ç¤ºå†å²è¶‹åŠ¿å›¾è¡¨
        function showHistoricalTrends(container) {
            // å¦‚æœåªæœ‰ä¸€ä¸ªå¿«ç…§ï¼Œä¸æ˜¾ç¤ºå†å²è¶‹åŠ¿
            if (dataSources.length < 2) {
                container.innerHTML = '<div style="padding: 60px; text-align: center; color: #7f8c8d;"><h3>å†å²è¶‹åŠ¿</h3><p>éœ€è¦è‡³å°‘2ä¸ªå†å²å¿«ç…§æ‰èƒ½å±•ç¤ºè¶‹åŠ¿å˜åŒ–</p></div>';
                return;
            }
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            const labels = dataSources.map(ds => {
                const meta = ds.metadata;
                return meta.description || `ç‰ˆæœ¬ ${meta.version}`;
            });
            
            // æå–èŠ‚ç‚¹ç±»å‹ç»Ÿè®¡æ•°æ®
            const nodeTypes = ['Aggregate', 'Command', 'DomainEvent', 'CommandHandler', 'DomainEventHandler', 
                              'IntegrationEventHandler', 'ControllerMethod', 'CommandSender', 'Endpoint'];
            
            const nodeDatasets = nodeTypes.map((type, index) => {
                const colors = [
                    '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
                    '#1abc9c', '#e67e22', '#34495e', '#16a085'
                ];
                
                return {
                    label: type,
                    data: dataSources.map(ds => ds.statistics.nodeStats[type] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '33',
                    tension: 0.4,
                    fill: false,
                    hidden: false
                };
            });
            
            // æå–å…³ç³»ç±»å‹ç»Ÿè®¡æ•°æ®
            const relationshipTypes = ['CommandHandlerToAggregate', 'CommandToHandler', 'AggregateToEntity', 
                                      'EntityMethodToDomainEvent', 'DomainEventToHandler', 'CommandHandlerToCommandSender',
                                      'ControllerToCommand', 'EndpointToCommand'];
            
            const relationshipDatasets = relationshipTypes.map((type, index) => {
                const colors = [
                    '#8e44ad', '#c0392b', '#27ae60', '#d35400', '#2980b9',
                    '#16a085', '#f39c12', '#7f8c8d'
                ];
                
                return {
                    label: type,
                    data: dataSources.map(ds => ds.statistics.relationshipStats[type] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '33',
                    tension: 0.4,
                    fill: false,
                    hidden: false
                };
            });
            
            // æ€»ä½“ç»Ÿè®¡æ•°æ®
            const totalDatasets = [
                {
                    label: 'æ€»å…ƒç´ æ•°',
                    data: dataSources.map(ds => ds.statistics.totalElements || 0),
                    borderColor: '#3498db',
                    backgroundColor: '#3498db33',
                    tension: 0.4,
                    fill: false
                },
                {
                    label: 'æ€»å…³ç³»æ•°',
                    data: dataSources.map(ds => ds.statistics.totalRelationships || 0),
                    borderColor: '#e74c3c',
                    backgroundColor: '#e74c3c33',
                    tension: 0.4,
                    fill: false
                }
            ];
            
            // åˆ›å»ºHTMLå®¹å™¨
            let html = '<div style="padding: 20px; height: calc(100vh - 140px); overflow-y: auto;">';
            
            // æ€»ä½“è¶‹åŠ¿å›¾
            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;">';
            html += '<h2 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 8px; font-size: 18px;">ğŸ“Š æ€»ä½“è¶‹åŠ¿</h2>';
            html += '<canvas id="totalTrendsChart" style="max-height: 300px;"></canvas>';
            html += '</div>';
            
            // å…ƒç´ ç±»å‹è¶‹åŠ¿å›¾
            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;">';
            html += '<h2 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 8px; font-size: 18px;">ğŸ“ˆ å…ƒç´ ç±»å‹è¶‹åŠ¿</h2>';
            html += '<canvas id="nodeTrendsChart" style="max-height: 400px;"></canvas>';
            html += '</div>';
            
            // å…³ç³»ç±»å‹è¶‹åŠ¿å›¾
            html += '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;">';
            html += '<h2 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #e74c3c; padding-bottom: 8px; font-size: 18px;">ğŸ”— å…³ç³»ç±»å‹è¶‹åŠ¿</h2>';
            html += '<canvas id="relationshipTrendsChart" style="max-height: 400px;"></canvas>';
            html += '</div>';
            
            html += '</div>';
            
            container.innerHTML = html;
            
            // å»¶è¿Ÿæ¸²æŸ“å›¾è¡¨ä»¥ç¡®ä¿DOMå·²æ›´æ–°
            setTimeout(() => {
                // æ¸²æŸ“æ€»ä½“è¶‹åŠ¿å›¾
                const totalCtx = document.getElementById('totalTrendsChart');
                if (totalCtx) {
                    new Chart(totalCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: totalDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    onClick: function(e, legendItem, legend) {
                                        const index = legendItem.datasetIndex;
                                        const chart = legend.chart;
                                        const meta = chart.getDatasetMeta(index);
                                        meta.hidden = !meta.hidden;
                                        chart.update();
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                }
                
                // æ¸²æŸ“å…ƒç´ ç±»å‹è¶‹åŠ¿å›¾
                const nodeCtx = document.getElementById('nodeTrendsChart');
                if (nodeCtx) {
                    new Chart(nodeCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: nodeDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    onClick: function(e, legendItem, legend) {
                                        const index = legendItem.datasetIndex;
                                        const chart = legend.chart;
                                        const meta = chart.getDatasetMeta(index);
                                        meta.hidden = !meta.hidden;
                                        chart.update();
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                }
                
                // æ¸²æŸ“å…³ç³»ç±»å‹è¶‹åŠ¿å›¾
                const relationshipCtx = document.getElementById('relationshipTrendsChart');
                if (relationshipCtx) {
                    new Chart(relationshipCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: relationshipDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    onClick: function(e, legendItem, legend) {
                                        const index = legendItem.datasetIndex;
                                        const chart = legend.chart;
                                        const meta = chart.getDatasetMeta(index);
                                        meta.hidden = !meta.hidden;
                                        chart.update();
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // åˆ‡æ¢å•ç‹¬é“¾è·¯å±•å¼€/æ”¶èµ·
        function toggleProcessingFlow() {
            processingFlowExpanded = !processingFlowExpanded;
            const container = document.getElementById('processingFlowContainer');
            const toggles = document.querySelectorAll('.expand-toggle');
            const processingToggle = toggles[1]; // ç¬¬äºŒä¸ªå±•å¼€/æ”¶èµ·æŒ‰é’®
            
            if (processingFlowExpanded) {
                container.classList.remove('chains-collapsed');
                if (processingToggle) processingToggle.textContent = 'â–¼';
            } else {
                container.classList.add('chains-collapsed');
                if (processingToggle) processingToggle.textContent = 'â–¶';
            }
        }

        // åˆ‡æ¢èšåˆå…³ç³»å›¾å±•å¼€/æ”¶èµ·
        function toggleAggregateDiagrams() {
            aggregateDiagramsExpanded = !aggregateDiagramsExpanded;
            const container = document.getElementById('aggregateDiagramsContainer');
            const toggles = document.querySelectorAll('.expand-toggle');
            const aggToggle = toggles[0]; // ç¬¬ä¸€ä¸ªå±•å¼€/æ”¶èµ·æŒ‰é’®
            if (aggregateDiagramsExpanded) {
                container.classList.remove('chains-collapsed');
                if (aggToggle) aggToggle.textContent = 'â–¼';
            } else {
                container.classList.add('chains-collapsed');
                if (aggToggle) aggToggle.textContent = 'â–¶';
            }
        }

        // æ·»åŠ URLå“ˆå¸Œå˜åŒ–ç›‘å¬
        function addHashChangeListener() {
            window.addEventListener('hashchange', handleHashChange);
        }

        // æ ¹æ®èšåˆåç§°æŸ¥æ‰¾ç´¢å¼•
        function findAggregateIndexByName(aggName, aggArray) {
            const decodedName = decodeURIComponent(aggName).replace(/-/g, ' ');
            for (let i = 0; i < aggArray.length; i++) {
                const normalizedAggName = aggArray[i].name.replace(/[^a-zA-Z0-9ä¸€-é¾¥]/g, '-');
                if (normalizedAggName === aggName || aggArray[i].name === decodedName) {
                    return i;
                }
            }
            return -1;
        }

        // å¤„ç†URLå“ˆå¸Œå˜åŒ–
        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;
            if (diagramConfigs[hash]) {
                showDiagram(hash, false);
                return;
            }
            if (hash.startsWith('aggregate-diagram-')) {
                const aggName = hash.substring(18);
                let aggIndex = findAggregateIndexByName(aggName, allAggregateRelationDiagrams);
                if (aggIndex === -1) {
                    aggIndex = parseInt(aggName);
                }
                if (!isNaN(aggIndex) && aggIndex >= 0 && aggIndex < allAggregateRelationDiagrams.length) {
                    showAggregateDiagram(aggIndex, false);
                    return;
                }
            }
            if (hash.startsWith('processing-flow-')) {
                const chainName = hash.substring(16);
                let chainIndex = -1;
                for (let i = 0; i < allChainFlowCharts.length; i++) {
                    const normalizedChainName = encodeURIComponent(allChainFlowCharts[i].name.replace(/[^a-zA-Z0-9]/g, '-'));
                    if (normalizedChainName === chainName) {
                        chainIndex = i;
                        break;
                    }
                }
                if (chainIndex === -1) {
                    chainIndex = parseInt(chainName);
                }
                if (!isNaN(chainIndex) && chainIndex >= 0 && chainIndex < allChainFlowCharts.length) {
                    showRequestChain(chainIndex, false);
                    return;
                }
            }
        }

        // å¤„ç†åˆå§‹URLå“ˆå¸Œ
        function handleInitialHash() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                handleHashChange();
            } else {
                showDiagram('Statistics', false);
            }
        }

        // æœç´¢åŠŸèƒ½
        let allSearchableItems = [];

        // åˆå§‹åŒ–æœç´¢æ•°æ®
        function initializeSearchData() {
            allSearchableItems = [];
            
            // æ·»åŠ èšåˆå…³ç³»å›¾ï¼ˆä¸èœå•ä¸€ä¸€å¯¹åº”ï¼‰
            allAggregateRelationDiagrams.forEach((agg, index) => {
                const aggId = encodeURIComponent(agg.name.replace(/[^a-zA-Z0-9ä¸€-é¾¥]/g, '-'));
                
                // ç®€å•ç›´æ¥ï¼šå°†å›¾è¡¨åç§°å’Œå›¾è¡¨å†…å®¹éƒ½ä½œä¸ºæœç´¢å†…å®¹
                const searchableTerms = [agg.name];
                
                // å¦‚æœå›¾è¡¨æœ‰å†…å®¹ï¼ˆdiagramæ–‡æœ¬ï¼‰ï¼Œä¹ŸåŠ å…¥æœç´¢èŒƒå›´
                if (agg.diagram) {
                    searchableTerms.push(agg.diagram);
                }
                
                allSearchableItems.push({
                    name: agg.name,
                    type: 'aggregateDiagram',
                    category: 'èšåˆå…³ç³»å›¾',
                    icon: 'ğŸ—‚ï¸',
                    target: `aggregate-diagram-${aggId}`,
                    index: index,
                    searchableTerms: searchableTerms
                });
            });
            
            // æ·»åŠ å¤„ç†æµç¨‹å›¾ï¼ˆä¸èœå•ä¸€ä¸€å¯¹åº”ï¼‰
            allChainFlowCharts.forEach((chain, index) => {
                const chainId = encodeURIComponent(chain.name.replace(/[^a-zA-Z0-9ä¸€-é¾¥]/g, '-'));
                
                // ç®€å•ç›´æ¥ï¼šå°†å›¾è¡¨åç§°å’Œå›¾è¡¨å†…å®¹éƒ½ä½œä¸ºæœç´¢å†…å®¹
                const searchableTerms = [chain.name];
                
                // å¦‚æœå›¾è¡¨æœ‰å†…å®¹ï¼ˆdiagramæ–‡æœ¬ï¼‰ï¼Œä¹ŸåŠ å…¥æœç´¢èŒƒå›´
                if (chain.diagram) {
                    searchableTerms.push(chain.diagram);
                }
                
                allSearchableItems.push({
                    name: chain.name,
                    type: 'processingFlow',
                    category: 'å¤„ç†æµç¨‹å›¾',
                    icon: 'ğŸ”„',
                    target: `processing-flow-${chainId}`,
                    index: index,
                    searchableTerms: searchableTerms
                });
            });
        }
        
        // æ ¹æ®èŠ‚ç‚¹ç±»å‹è·å–å›¾æ ‡
        function getIconForNodeType(nodeType) {
            const iconMap = {
                'Controller': 'ğŸ®',
                'Service': 'âš™ï¸',
                'Repository': 'ğŸ—„ï¸',
                'Entity': 'ğŸ“¦',
                'Aggregate': 'ğŸ›ï¸',
                'Command': 'âš¡',
                'Query': 'ğŸ”',
                'Event': 'ğŸ“¡',
                'Handler': 'ğŸ› ï¸',
                'Interface': 'ğŸ”Œ',
                'Class': 'ğŸ“„',
                'Enum': 'ğŸ“',
                'Value': 'ğŸ’'
            };
            return iconMap[nodeType] || 'ğŸ“„';
        }

        function selectSearchResult(item) {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchBox').value = '';
            
            switch (item.type) {
                case 'aggregateDiagram':
                    // ç›´æ¥è°ƒç”¨æ˜¾ç¤ºå‡½æ•°ï¼Œå®ƒä¼šå¤„ç†å±•å¼€å’Œæ¿€æ´»
                    showAggregateDiagram(item.index);
                    break;
                case 'processingFlow':
                    // ç›´æ¥è°ƒç”¨æ˜¾ç¤ºå‡½æ•°ï¼Œå®ƒä¼šå¤„ç†å±•å¼€å’Œæ¿€æ´»
                    showRequestChain(item.index);
                    break;
            }
        }
        
        // åœ¨å›¾è¡¨ä¸­é«˜äº®æ˜¾ç¤ºå…ƒç´ ï¼ˆè¿™ä¸ªåŠŸèƒ½éœ€è¦æ ¹æ®Mermaidçš„APIæ¥å®ç°ï¼‰
        function highlightElementInDiagram(nodeId) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ é«˜äº®é€»è¾‘ï¼Œæ¯”å¦‚æ»šåŠ¨åˆ°å…ƒç´ ä½ç½®ã€æ”¹å˜å…ƒç´ é¢œè‰²ç­‰
            // ç”±äºMermaidå›¾è¡¨çš„é™åˆ¶ï¼Œè¿™ä¸ªåŠŸèƒ½å¯èƒ½éœ€è¦æ›´å¤æ‚çš„å®ç°
            console.log('Highlighting element:', nodeId);
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—æœç´¢ç»“æœ
        document.addEventListener('click', function(event) {
            const searchContainer = document.querySelector('.search-container');
            if (!searchContainer.contains(event.target)) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });

        // é”®ç›˜å¯¼èˆªæ”¯æŒ
        document.getElementById('searchBox').addEventListener('keydown', function(event) {
            const searchResults = document.getElementById('searchResults');
            const resultItems = searchResults.querySelectorAll('.search-result-item');

            if (event.key === 'Escape') {
                searchResults.style.display = 'none';
                this.value = '';
                return;
            }

            if (event.key === 'Enter' && resultItems.length > 0) {
                const highlighted = searchResults.querySelector('.search-result-item.highlight');
                if (highlighted) {
                    highlighted.click();
                } else {
                    resultItems[0].click();
                }
                return;
            }

            if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
                event.preventDefault();
                const highlighted = searchResults.querySelector('.search-result-item.highlight');
                let nextIndex = 0;

                if (highlighted) {
                    highlighted.classList.remove('highlight');
                    const currentIndex = Array.from(resultItems).indexOf(highlighted);
                    if (event.key === 'ArrowDown') {
                        nextIndex = (currentIndex + 1) % resultItems.length;
                    } else {
                        nextIndex = (currentIndex - 1 + resultItems.length) % resultItems.length;
                    }
                }

                if (resultItems[nextIndex]) {
                    resultItems[nextIndex].classList.add('highlight');
                }
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            initializeSearchData();
            initializeSidebar();
        });
        
        // ä¾§è¾¹æ åŠŸèƒ½
        let sidebarWidth = 280;
        let isDragging = false;
        
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const resizer = document.getElementById('sidebarResizer');
            
            // åˆå§‹åŒ–CSSå˜é‡
            document.documentElement.style.setProperty('--sidebar-width', sidebarWidth + 'px');
            // åˆå§‹åŒ–æ‹–æ‹½çº¿ä½ç½®
            resizer.style.left = `${sidebarWidth}px`;
            
            // æ‹–æ‹½è°ƒæ•´å®½åº¦
            resizer.addEventListener('mousedown', initResize);
            
            function initResize(e) {
                isDragging = true;
                resizer.classList.add('dragging');
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            }
            
            function doResize(e) {
                if (!isDragging) return;
                
                const newWidth = e.clientX;
                if (newWidth >= 200 && newWidth <= 500) {
                    sidebarWidth = newWidth;
                    sidebar.style.width = newWidth + 'px';
                    // æ›´æ–°CSSå˜é‡
                    document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
                    // æ›´æ–°æ‹–æ‹½çº¿ä½ç½®
                    resizer.style.left = `${newWidth}px`;
                    
                    // å¼ºåˆ¶é‡ç»˜æ‰€æœ‰å­å…ƒç´ 
                    const allItems = sidebar.querySelectorAll('.nav-item');
                    allItems.forEach(item => {
                        item.style.width = '100%';
                    });
                }
            }
            
            function stopResize() {
                isDragging = false;
                resizer.classList.remove('dragging');
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        }
        window.showAggregateDiagram = showAggregateDiagram;
        // æ˜¾ç¤ºèšåˆå…³ç³»å›¾
        async function showAggregateDiagram(aggIndex, updateHash = true) {
            const agg = allAggregateRelationDiagrams[aggIndex];
            if (!agg) return;

            if (!aggregateDiagramsExpanded) {
                toggleAggregateDiagrams();
            }

            if (updateHash) {
                const aggId = encodeURIComponent(agg.name.replace(/[^a-zA-Z0-9ä¸€-é¾¥]/g, '-'));
                window.location.hash = `aggregate-diagram-${aggId}`;
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-aggregate-diagram="${aggIndex}"]`).classList.add('active');

            document.getElementById('diagramTitle').textContent = `${agg.name}`;
            document.getElementById('diagramDescription').textContent = 'èšåˆæ ¹ç›¸å…³çš„å…³ç³»å›¾';
            hideMermaidLiveButton();

            const contentDiv = document.getElementById('diagramContent');
            contentDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆèšåˆå…³ç³»å›¾...</div>';

            try {
                setTimeout(function() {
                    renderMermaidDiagram(agg.diagram, contentDiv).then(() => {
                        currentDiagram = `aggregate-diagram-${aggIndex}`;
                        currentDiagramData = agg.diagram;
                        showMermaidLiveButton();
                    }).catch(error => {
                        console.error('ç”Ÿæˆèšåˆå…³ç³»å›¾å¤±è´¥:', error);
                        contentDiv.innerHTML = `<div class="error">${formatErrorMessage('ç”Ÿæˆèšåˆå…³ç³»å›¾å¤±è´¥', error)}</div>`;
                        currentDiagram = `aggregate-diagram-${aggIndex}`;
                        currentDiagramData = agg.diagram;
                        showMermaidLiveButton();
                    });
                }, 200);
            } catch (error) {
                console.error('ç”Ÿæˆèšåˆå…³ç³»å›¾å¤±è´¥:', error);
                contentDiv.innerHTML = `<div class="error">${formatErrorMessage('ç”Ÿæˆèšåˆå…³ç³»å›¾å¤±è´¥', error)}</div>`;
                currentDiagram = `aggregate-diagram-${aggIndex}`;
                currentDiagramData = agg.diagram;
                showMermaidLiveButton();
            }
        }
    </script>
</body>
</html>
