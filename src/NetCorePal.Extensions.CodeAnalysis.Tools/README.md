# NetCorePal.Extensions.CodeAnalysis.Tools

基于 NetCorePal 代码分析框架的命令行工具，用于从 .NET 项目生成交互式架构可视化 HTML 文件。

## 功能特性

- **智能发现**：自动发现并分析解决方案或项目
- **依赖递归分析**：自动分析项目依赖关系，确保完整的架构视图
- **多类型图表**：生成架构总览图、处理流程图、聚合关系图等
- **交互式HTML**：提供完整的导航、图表切换和在线编辑功能
- **Mermaid Live集成**：一键跳转到 Mermaid Live Editor 进行在线编辑
- **.NET 10 单文件执行**：利用 .NET 10 的单文件运行能力，动态生成和执行分析代码
- **📊 历史记录特性**：类似 EF Core 迁移，支持版本快照、历史比较和趋势展示

## 快速开始

### 前提条件

- **需要安装 .NET 10 SDK**：单文件执行依赖 .NET 10 特性
- **SDK 与目标框架的区别**：虽然工具需要 .NET 10 SDK 来运行，但它可以分析使用 `net8.0`、`net9.0` 或 `net10.0` 作为目标框架的项目
- 目标项目必须引用 `NetCorePal.Extensions.CodeAnalysis` 包
- 该包包含源生成器，在编译时自动生成代码分析元数据

### 安装

```bash
dotnet tool install -g NetCorePal.Extensions.CodeAnalysis.Tools
```

安装预览版：

```bash
dotnet tool install -g NetCorePal.Extensions.CodeAnalysis.Tools --prerelease  --source https://www.myget.org/F/netcorepal/api/v3/index.json
```

### 使用

```bash
# 进入项目目录
cd MyApp

# 自动发现并分析当前目录下的解决方案或项目
netcorepal-codeanalysis generate

# 指定解决方案文件
netcorepal-codeanalysis generate --solution MySolution.sln

# 指定项目文件
netcorepal-codeanalysis generate --project MyProject.csproj

# 自定义输出和标题
netcorepal-codeanalysis generate --output my-architecture.html --title "我的架构图"

# 启用详细输出
netcorepal-codeanalysis generate --verbose
```

### 命令参数

| 选项 | 别名 | 类型 | 默认值 | 说明 |
|---|---|---|---|---|
| `--solution <solution>` | `-s` | 文件路径 | 无 | 要分析的解决方案文件，支持 `.sln`/`.slnx` |
| `--project <project>` | `-p` | 文件路径（可多次） | 无 | 要分析的项目文件（`.csproj`），可重复指定多个 |
| `--output <output>` | `-o` | 文件路径 | `architecture-visualization.html` | 输出的 HTML 文件路径 |
| `--title <title>` | `-t` | 字符串 | `架构可视化` | 生成页面的标题 |
| `--verbose` | `-v` | 开关 | `false` | 启用详细日志输出 |
| `--include-tests` | 无 | 开关 | `false` | 包含测试项目（默认不包含；规则见下文“测试项目识别规则”） |

### 自动发现行为

- 默认策略：当未提供 `--solution` 与 `--project` 时，工具会在“当前目录（顶层）”自动发现分析目标。
- 发现优先级：
  1) 优先使用 `.slnx`
  2) 其次使用 `.sln`
  3) 若无解决方案文件，则收集当前目录顶层的 `*.csproj`
- 非递归：不递归扫描子目录，仅检查当前目录的顶层文件。
- 运行时提示：选择 `.slnx/.sln` 时将明确打印“Using solution (.slnx/.sln): <文件名>”。

如需显式指定，推荐：

```bash
# 指定解决方案
netcorepal-codeanalysis generate --solution MySolution.slnx

# 或指定若干项目
netcorepal-codeanalysis generate --project A.csproj --project B.csproj
```

### 测试项目识别规则

- 默认行为：测试项目会被排除在分析之外（除非显式传入 `--include-tests`）。
- 判定规则（满足任一即视为测试项目）：
  - 项目文件所在路径的任一父级目录名为 `test` 或 `tests`（不区分大小写）。
  - 项目文件（.csproj）中包含 `<IsTestProject>true</IsTestProject>`。

若需包含测试项目，请使用：

```bash
netcorepal-codeanalysis generate --include-tests
```

## 历史记录特性（类似 EF Core 迁移）

工具提供了版本快照功能，可以追踪架构的演进历史，类似于 Entity Framework Core 的迁移机制。

**快照以C#代码文件形式保存**，类似EF Core的迁移快照，便于版本控制和代码审查。

### 创建快照

```bash
# 在当前目录创建项目架构快照（自动发现项目）
netcorepal-codeanalysis snapshot add --description "初始版本"

# 快照将保存为 Snapshots/Snapshot_20260116120000_InitialVersion.cs

# 指定项目文件创建快照
netcorepal-codeanalysis snapshot add --project MyProject.csproj --description "添加订单模块"

# 快照将保存为 Snapshots/Snapshot_20260116120000_AddedOrderModule.cs

# 指定快照名称（可选，EF Core 风格）
netcorepal-codeanalysis snapshot add --project MyProject.csproj --name "AddedPaymentFeature" --description "添加支付功能"

# 快照将保存为 Snapshots/Snapshot_20260116120000_AddedPaymentFeature.cs

# 指定快照目录
netcorepal-codeanalysis snapshot add --project MyProject.csproj --snapshot-dir ./MySnapshots --description "重构"
```

**重要变更**：
- ✅ 快照文件名遵循 EF Core 迁移命名约定：`Snapshot_{Version}_{Name}.cs`
- ✅ 快照始终保存在项目目录中（相对路径相对于项目目录解析）
- ✅ 生成的类名始终有效（以 `Snapshot_` 前缀开头，避免数字开头）
- ✅ 所有 MetadataAttribute 参数和数组元素正确引用
- ✅ `snapshot add` 命令仅支持项目文件（不支持解决方案文件）

快照文件示例（Snapshot_20260116120000.cs）：
```csharp
// <auto-generated />
// Snapshot created: 2026-01-16 12:00:00
// Description: 初始版本

namespace CodeAnalysisSnapshots
{
    public partial class Snapshot_20260116120000
    {
        public static CodeFlowAnalysisSnapshot BuildSnapshot()
        {
            // ... 快照数据
        }
    }
}
```

### 生成带历史记录的HTML

```bash
# 默认生成包含历史快照的交互式HTML（自动通过反射发现快照）
netcorepal-codeanalysis generate

# 生成的HTML包含：
# - 当前版本的完整架构分析
# - 所有历史快照（如果存在）
# - 版本选择器下拉框（多个快照时显示）
# - 历史趋势图表（2个或更多快照时显示）
# - 交互式图例和响应式图表

# 禁用历史记录功能（不包含历史快照）
netcorepal-codeanalysis generate --no-history

# 指定输出文件
netcorepal-codeanalysis generate --output history.html --title "架构演进历史"
```

**快照发现机制**：
- ✅ 自动通过反射从项目程序集中发现所有快照类
- ✅ 快照类必须继承自 `CodeFlowAnalysisSnapshot`
- ✅ 只有代码变化时才会添加新快照（基于 hash 比较）
- ✅ 快照按版本自动排序（最新的在前）
- ✅ 无需手动指定快照目录

生成的HTML页面包含：
- 📊 **版本选择器**：交互式下拉框，可切换查看不同版本的架构（如果存在多个快照）
  - 自动显示快照描述和时间戳
  - 切换版本时自动刷新所有图表和统计信息
  - 专业深色主题样式，与页面整体风格一致
- 📈 **历史趋势图表**（2个或更多快照时显示）：
  - **总体趋势**：展示总元素数量和总关系数量随时间变化
  - **元素类型趋势**：跟踪 Aggregate、Command、DomainEvent 等各类型数量变化
  - **关系类型趋势**：跟踪 CommandToHandler、AggregateToDomainEvent 等关系数量变化
  - **交互式图例**：点击图例项可显示/隐藏对应指标
  - **响应式图表**：使用 Chart.js 库，支持缩放和详细数据提示
  - **过滤一致性**：趋势图表使用与统计信息页面相同的过滤规则
- 🔍 **版本间一致性**：所有视图（统计、架构图、流程图）在不同快照间自动同步
- 📝 **版本信息**：每个快照包含完整的元数据（时间戳、描述、hash、节点和关系数量）

**注意**：
- 如果没有快照文件，将自动生成不含历史的HTML（仅显示当前版本）
- 快照通过反射自动发现，无需手动指定快照目录
- 只有当代码实际变化（hash不同）时才会创建新快照

### 典型工作流程

```bash
# 1. 初始架构快照
netcorepal-codeanalysis snapshot add --description "项目初始版本"

# 2. 开发新功能...

# 3. 创建新快照
netcorepal-codeanalysis snapshot add --description "添加支付功能"

# 4. 生成可视化HTML（默认包含历史，通过反射自动发现所有快照）
netcorepal-codeanalysis generate --output architecture.html

# 5. 打开生成的HTML文件查看快照历史和趋势图表

# 6. 提交快照到版本控制（推荐）
git add Snapshots/
git commit -m "Add architecture snapshot"
```

### 版本控制集成

快照以 C# 代码文件形式保存，建议将其提交到版本控制系统：

```bash
# 将快照目录添加到版本控制
git add Snapshots/
git commit -m "Add architecture snapshot: [描述]"
```

**优势**：
- ✅ 类型安全，编译时检查
- ✅ 易于代码审查和diff
- ✅ 自然集成到Git工作流
- ✅ 遵循EF Core迁移的最佳实践



该工具采用基于 .NET 10 单文件执行能力的全新架构：

1. **项目发现**：自动发现目标解决方案或项目文件
2. **依赖分析**：递归分析项目引用，获取所有相关项目
3. **动态代码生成**：生成包含 `#:project` 指令的临时 C# 文件
4. **单文件执行**：使用 `dotnet run app.cs` 执行分析
5. **结果生成**：生成交互式 HTML 可视化文件
6. **自动清理**：删除临时文件

## 完整文档

详细的使用说明、命令行选项、集成方式和故障排除，请参阅：

- [中文文档](https://netcorepal.github.io/netcorepal-cloud-framework/zh/code-analysis/code-analysis-tools/)
- [English Documentation](https://netcorepal.github.io/netcorepal-cloud-framework/en/code-analysis/code-analysis-tools/)

## 本地开发

```bash
cd src/NetCorePal.Extensions.CodeAnalysis.Tools
dotnet pack -o .
dotnet tool uninstall -g NetCorePal.Extensions.CodeAnalysis.Tools
dotnet tool install -g NetCorePal.Extensions.CodeAnalysis.Tools --add-source .

# test
dotnet test test/NetCorePal.Extensions.CodeAnalysis.Tools.UnitTests/NetCorePal.Extensions.CodeAnalysis.Tools.UnitTests.csproj
```
